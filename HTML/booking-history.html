<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <title>Booking History</title>
    <style>
      .status-confirmed {
        color: green;
      }
      .status-pending {
        color: red;
      }
      .cancel-button {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h2 class="text-center">Your Booking History</h2>
      <table class="table table-striped mt-4">
        <thead>
          <tr>
            <th>Room Image</th>
            <th>Check-in Date</th>
            <th>Check-out Date</th>
            <th>Guest Number</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="booking-history-table">
          <!-- Bookings will be dynamically loaded here -->
        </tbody>
      </table>
    </div>

    <script src="app.js"></script>
    <script>
      // Fetch booking data from the API
      const userId = localStorage.getItem("user_id")
      fetch(`http://127.0.0.1:8000/bookings/?user_id=${userId}`)
        .then((response) => response.json())
        .then((bookings) => {
          const tableBody = document.getElementById('booking-history-table');
          bookings.forEach((booking) => {
            const row = document.createElement('tr');

            // Room image
            const roomImageCell = document.createElement('td');
            const roomImage = document.createElement('img');
            roomImage.src = booking.image;
            roomImage.alt = 'Room Image';
            roomImage.style.width = '100px';
            roomImageCell.appendChild(roomImage);
            row.appendChild(roomImageCell);

            // Check-in date
            const checkInCell = document.createElement('td');
            checkInCell.textContent = booking.check_in_date;
            row.appendChild(checkInCell);

            // Check-out date
            const checkOutCell = document.createElement('td');
            checkOutCell.textContent = booking.check_out_date;
            row.appendChild(checkOutCell);

            // Guest number
            const guestNumberCell = document.createElement('td');
            guestNumberCell.textContent = booking.guest_number;
            row.appendChild(guestNumberCell);

            // Status
            const statusCell = document.createElement('td');
            statusCell.textContent = booking.status;
            if (booking.status === 'Confirmed') {
              statusCell.classList.add('status-confirmed');
            } else if (booking.status === 'Pending') {
              statusCell.classList.add('status-pending');
            }
            row.appendChild(statusCell);

            // Action (Cancel button)
            const actionCell = document.createElement('td');
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.classList.add('btn', 'btn-danger', 'cancel-button');
            if (booking.status === 'Confirmed') {
              cancelButton.disabled = true;
            } else {
              cancelButton.onclick = () => cancelBooking(booking.id);
            }
            actionCell.appendChild(cancelButton);
            row.appendChild(actionCell);

            // Append row to table
            tableBody.appendChild(row);
          });
        })
        .catch((error) => console.error('Error fetching bookings:', error));

      // Function to cancel a booking
      function cancelBooking(bookingId) {
        fetch(`http://127.0.0.1:8000/bookings/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        })
          .then((response) => {
            if (response.ok) {
              alert('Booking cancelled successfully!');
              location.reload();
            } else {
              alert('Failed to cancel booking.');
            }
          })
          .catch((error) => console.error('Error cancelling booking:', error));
      }
    </script>
  </body>
</html>
